# Hook, HTTP, Options, DB, and Route Inventory

## 1) add_action / add_filter Map
- `plugins_loaded` → `DSB_Plugin::instance` (`Davix Subscription Bridge.php`:40-42).【F:Davix Subscription Bridge.php†L38-L42】
- `delete_user` → `dsb_handle_delete_user_pre`; `deleted_user` → `dsb_handle_deleted_user_post`; `remove_user_from_blog` → `dsb_handle_delete_user_pre` (`includes/class-dsb-user-purger.php`:16-18).【F:includes/class-dsb-user-purger.php†L13-L18】
- `cron_schedules` → `DSB_Node_Poll::register_schedule` (`includes/class-dsb-node-poll.php`:26-29).【F:includes/class-dsb-node-poll.php†L24-L29】
- `dsb_node_poll` (CRON_HOOK) → `DSB_Node_Poll::run` (`includes/class-dsb-node-poll.php`:27-29).【F:includes/class-dsb-node-poll.php†L24-L29】
- `init` → `DSB_Node_Poll::maybe_schedule` (`includes/class-dsb-node-poll.php`:29-30).【F:includes/class-dsb-node-poll.php†L27-L30】
- `admin_menu` → `DSB_Admin::register_menu`; `admin_init` → `DSB_Admin::handle_actions`; `admin_enqueue_scripts` → `DSB_Admin::enqueue_assets`; `admin_post_dsb_download_log` → `DSB_Admin::handle_download_log`; `admin_post_dsb_clear_log` → `DSB_Admin::handle_clear_log`; `admin_post_dsb_run_resync_now` → `DSB_Admin::handle_run_resync_now`; `admin_post_dsb_run_node_poll_now` → `DSB_Admin::handle_run_node_poll_now`; `wp_ajax_dsb_search_users` → `DSB_Admin::ajax_search_users`; `wp_ajax_dsb_search_subscriptions` → `DSB_Admin::ajax_search_subscriptions`; `wp_ajax_dsb_search_orders` → `DSB_Admin::ajax_search_orders`; `wp_ajax_dsb_js_log` → `dsb_handle_js_log`; `woocommerce_product_data_panels` → `DSB_Admin::render_plan_limits_panel`; `woocommerce_admin_process_product_object` → `DSB_Admin::save_plan_limits_meta`; `save_post_product` → `DSB_Admin::maybe_sync_product_by_post`; `woocommerce_update_product` → `DSB_Admin::maybe_sync_product` (`includes/class-dsb-admin.php`:29-44).【F:includes/class-dsb-admin.php†L26-L44】
- `woocommerce_product_data_tabs` → `DSB_Admin::add_plan_limits_tab` (`includes/class-dsb-admin.php`:40).【F:includes/class-dsb-admin.php†L40-L40】
- `wp_ajax_dsb_dashboard_summary` → `DSB_Dashboard_Ajax::summary`; `wp_ajax_dsb_dashboard_usage` → `DSB_Dashboard_Ajax::usage`; `wp_ajax_dsb_dashboard_rotate` → `DSB_Dashboard_Ajax::rotate_key`; `wp_ajax_dsb_dashboard_toggle` → `DSB_Dashboard_Ajax::toggle_key`; `wp_ajax_dsb_dashboard_logs` → `DSB_Dashboard_Ajax::logs` (`includes/class-dsb-dashboard-ajax.php`:79-84).【F:includes/class-dsb-dashboard-ajax.php†L79-L84】
- `admin_notices` → `DSB_Plugin::dependency_notice` (`includes/class-dsb-plugin.php`:73-90).【F:includes/class-dsb-plugin.php†L73-L90】
- `user_register` → `DSB_Plugin::handle_user_register_free` (`includes/class-dsb-plugin.php`:91).【F:includes/class-dsb-plugin.php†L91-L91】
- `init` → `DSB_Plugin::init` (`includes/class-dsb-plugin.php`:93).【F:includes/class-dsb-plugin.php†L93-L93】
- `dsb_resync_cron` (CRON_HOOK) → `DSB_Resync::handle_cron`; `init` → `DSB_Resync::maybe_schedule_cron` (`includes/class-dsb-resync.php`:24-25).【F:includes/class-dsb-resync.php†L24-L25】
- `wps_sfw_after_renewal_payment` → `DSB_Events::handle_wps_renewal`; `wps_sfw_expire_subscription_scheduler` → `DSB_Events::handle_wps_expire`; `wps_sfw_subscription_cancel` → `DSB_Events::handle_wps_cancel`; `wps_sfw_after_created_subscription` → `DSB_Events::handle_wps_subscription_created`; `wps_sfw_subscription_order` → `DSB_Events::handle_wps_subscription_order_created`; `wps_sfw_subscription_process_checkout` → `DSB_Events::handle_wps_subscription_process_checkout`; `woocommerce_checkout_order_processed` → `DSB_Events::handle_checkout`; `woocommerce_order_status_changed` → `DSB_Events::handle_order_status_change`; `dsb_retry_provision_order` → `DSB_Events::retry_provision_order`; `dsb_backfill_valid_until_for_subscription` → `DSB_Events::backfill_valid_until_for_subscription` (`includes/class-dsb-events.php`:25-38).【F:includes/class-dsb-events.php†L25-L38】
- `wps_sfw_susbcription_end_date` → `DSB_Events::dsb_capture_wps_expiry` (`includes/class-dsb-events.php`:40).【F:includes/class-dsb-events.php†L40-L40】
- `cron_schedules` → `DSB_Purge_Worker::register_schedule`; `dsb_purge_worker` (CRON_HOOK) → `DSB_Purge_Worker::run`; `init` → `DSB_Purge_Worker::maybe_schedule` (`includes/class-dsb-purge-worker.php`:26-30).【F:includes/class-dsb-purge-worker.php†L26-L30】
- `wp_enqueue_scripts` → `DSB_Dashboard::maybe_enqueue_assets` (`includes/class-dsb-dashboard.php`:14-16).【F:includes/class-dsb-dashboard.php†L14-L16】

## 2) Outbound PixLab HTTP Calls
- Core request builder `DSB_Client::request` posts/gets to `node_base_url` + path with header `x-davix-bridge-token` and optional JSON body; 15s timeout (`includes/class-dsb-client.php`:328-355). Responses tagged with method/URL for debugging (`includes/class-dsb-client.php`:355-364).【F:includes/class-dsb-client.php†L328-L364】
- Provision/update events use `DSB_Client::post_internal` → `request` with payload (customer_email, plan_slug, subscription/order IDs, etc.) and log/bookkeeping; retries handled by events class (see §1 hooks) using `dsb_retry_provision_order` scheduling (payload stored via order meta) (`includes/class-dsb-client.php`:379-500).【F:includes/class-dsb-client.php†L379-L500】
- Successful responses upsert truth tables with key status, prefix/last4, valid_from/valid_until, plan, node_plan_id; failures mark status error and store last_http_code/error (`includes/class-dsb-client.php`:426-520).【F:includes/class-dsb-client.php†L426-L520】
- Dashboard AJAX calls: `user_summary`/`user_usage`/`rotate_key`/`toggle_key`/`user_logs` all call PixLab via DSB_Client; identity includes wp_user_id/subscription_id/order_id/email sanitized from current user/session (`includes/class-dsb-dashboard-ajax.php`:87-176).【F:includes/class-dsb-dashboard-ajax.php†L87-L176】
- Admin tooling sync endpoints: product sync, plan sync, diagnostics use `DSB_Admin` methods invoking `DSB_Client` (e.g., log download, plan sync) with same headers/body building and parsing (see `includes/class-dsb-admin.php`:618-1760).【F:includes/class-dsb-admin.php†L618-L1760】
- No explicit backoff in HTTP layer; retries scheduled via WooCommerce order meta and WP-Cron `dsb_retry_provision_order` with max attempts 10 (`includes/class-dsb-events.php`:15, 292-343).【F:includes/class-dsb-events.php†L15-L15】【F:includes/class-dsb-events.php†L292-L343】

## 3) WordPress Options
- `dsb_settings` (array): node_base_url, bridge_token, enable_logging, debug flags, delete_data, provision flag, resync/node poll/purge settings, style/label overrides; defaults in `DSB_Client::get_settings` (`includes/class-dsb-client.php`:18-49). Validation/sanitization in `save_settings` (`includes/class-dsb-client.php`:195-298).【F:includes/class-dsb-client.php†L18-L49】【F:includes/class-dsb-client.php†L195-L298】
- `dsb_product_plans` (array product_id→plan_slug) normalized in `get_product_plans` and rewritten in `save_settings` (`includes/class-dsb-client.php`:154-177, 262-296).【F:includes/class-dsb-client.php†L154-L177】【F:includes/class-dsb-client.php†L262-L296】
- `dsb_plan_products` (array of product IDs) handled in `get_plan_products` and `save_settings` (`includes/class-dsb-client.php`:179-185, 243-297).【F:includes/class-dsb-client.php†L179-L185】【F:includes/class-dsb-client.php†L243-L297】
- `dsb_plan_sync` status map stored/read via `get_plan_sync_status` (`includes/class-dsb-client.php`:187-193).【F:includes/class-dsb-client.php†L187-L193】
- `dsb_delete_on_uninstall` (bool) and `dsb_db_version` maintained by `DSB_DB::migrate`/`drop_tables`/`save_settings` (`includes/class-dsb-db.php`:6-10,145-165) and `save_settings` (`includes/class-dsb-client.php`:294-297).【F:includes/class-dsb-db.php†L6-L10】【F:includes/class-dsb-db.php†L145-L165】【F:includes/class-dsb-client.php†L294-L297】
- Resync/node-poll/purge scheduler lock and metadata options: `dsb_resync_lock_until`, `dsb_resync_last_run_at`, `dsb_resync_last_result`, `dsb_resync_last_error`; `dsb_node_poll_lock_until`, etc.; `dsb_purge_lock_until`, `dsb_purge_last_run_at`, `dsb_purge_last_result`, `dsb_purge_last_error`, `dsb_purge_last_duration_ms`, `dsb_purge_last_processed` referenced in uninstall cleanup (`includes/class-dsb-plugin.php`:40-66).【F:includes/class-dsb-plugin.php†L40-L66】
- Dashboard style/label defaults pulled from options via `DSB_Client::get_style_settings`/`get_label_settings` using same `dsb_settings` array (`includes/class-dsb-client.php`:18-49, 244-259).【F:includes/class-dsb-client.php†L18-L49】【F:includes/class-dsb-client.php†L243-L259】

## 4) Database Tables
- `{$prefix}davix_bridge_logs`: id BIGINT PK, event, customer_email, plan_slug, subscription_id, order_id, response_action, http_code, error_excerpt, created_at; index on subscription_id (`includes/class-dsb-db.php`:35-48).【F:includes/class-dsb-db.php†L35-L48】
- `{$prefix}davix_bridge_purge_queue`: id PK, wp_user_id, customer_email, subscription_id, reason, status (default pending), attempts, claim_token, locked_until, started_at, finished_at, next_run_at, last_error, created_at, updated_at; indexes on status, (status,locked_until), wp_user_id, customer_email, subscription_id, claim_token (`includes/class-dsb-db.php`:50-73).【F:includes/class-dsb-db.php†L50-L73】
- `{$prefix}davix_bridge_keys`: id PK, subscription_id (unique), customer_email, wp_user_id (unique), customer_name, subscription_status, plan_slug, status, key_prefix, key_last4, valid_from, valid_until, node_plan_id, last_action, last_http_code, last_error, created_at, updated_at; index on customer_email (`includes/class-dsb-db.php`:75-98).【F:includes/class-dsb-db.php†L75-L98】
- `{$prefix}davix_bridge_user`: id PK, wp_user_id (unique), customer_email, subscription_id, order_id, product_id, plan_slug, status, valid_from, valid_until, source, last_sync_at, created_at, updated_at; indexes on email, subscription_id, status, plan_slug (`includes/class-dsb-db.php`:100-121).【F:includes/class-dsb-db.php†L100-L121】
- Triggers created (if missing) to enqueue purge rows on delete from keys/user tables (`includes/class-dsb-db.php`:167-203).【F:includes/class-dsb-db.php†L167-L203】

## 5) Shortcodes and AJAX Routes
- Shortcode `PIXLAB_DASHBOARD` renders customer dashboard; requires logged-in user else login message; enqueues CSS/JS and styles; assets enqueued only on singular pages containing shortcode (`includes/class-dsb-dashboard.php`:14-177).【F:includes/class-dsb-dashboard.php†L14-L177】
- AJAX (auth: logged-in via `wp_ajax_`):
  - `dsb_dashboard_summary` → `DSB_Dashboard_Ajax::summary` validates current user identity, calls PixLab summary, normalizes payload, outputs JSON (`includes/class-dsb-dashboard-ajax.php`:79-104).【F:includes/class-dsb-dashboard-ajax.php†L79-L104】
  - `dsb_dashboard_usage` → `DSB_Dashboard_Ajax::usage` validates identity, sanitizes `range`, calls PixLab usage with window, responds JSON (`includes/class-dsb-dashboard-ajax.php`:106-147).【F:includes/class-dsb-dashboard-ajax.php†L106-L147】
  - `dsb_dashboard_logs` → `DSB_Dashboard_Ajax::logs` validates identity, paginates/sanitizes, calls PixLab logs endpoint, returns JSON (`includes/class-dsb-dashboard-ajax.php`:149-213).【F:includes/class-dsb-dashboard-ajax.php†L149-L213】
  - `dsb_dashboard_rotate` → `DSB_Dashboard_Ajax::rotate_key` validates identity, calls PixLab rotate, returns key info (`includes/class-dsb-dashboard-ajax.php`:215-260).【F:includes/class-dsb-dashboard-ajax.php†L215-L260】
  - `dsb_dashboard_toggle` → `DSB_Dashboard_Ajax::toggle_key` validates identity, toggles enable/disable via PixLab, returns status (`includes/class-dsb-dashboard-ajax.php`:262-304).【F:includes/class-dsb-dashboard-ajax.php†L262-L304】
- Admin AJAX (capability checked inside handler): `dsb_search_users`, `dsb_search_subscriptions`, `dsb_search_orders`, `dsb_js_log` (`includes/class-dsb-admin.php`:29-39). Nonce checks in form handlers within admin pages (see same file) accompany capabilities.
