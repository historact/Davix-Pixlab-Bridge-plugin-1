Davix Subscription Bridge Plugin – Detailed Technical Documentation
================================================================
Overview
--------
Davix Subscription Bridge is a WordPress plugin that synchronizes WooCommerce/WPSwings subscription events with a Davix Node.js licensing API. It provides:
- Automatic event forwarding for subscription lifecycle changes to the Node service.
- Admin UI for configuring Node connectivity, mapping WooCommerce products to plan slugs, viewing logs, and managing API keys.
- A customer-facing dashboard shortcode that exposes API key status, usage charts, and rotation/toggle actions via AJAX.
- Helper Node.js routes (in the `node/` folder) illustrating the expected backend contract for admin features and plan synchronization.

Key constants and bootstrapping (`Davix Subscription Bridge.php`)
---------------------------------------------------------------
- Defines plugin metadata and constants (`DSB_VERSION`, `DSB_PLUGIN_FILE`, `DSB_PLUGIN_DIR`, `DSB_PLUGIN_URL`).
- Loads all class files under `includes/` and registers activation/uninstall hooks on `DSB_Plugin::activate`/`uninstall`.
- On `plugins_loaded`, instantiates the singleton `DSB_Plugin` (priority 20) to bootstrap all functionality.

Plugin lifecycle (`includes/class-dsb-plugin.php`)
--------------------------------------------------
- `dependencies_met()` ensures WooCommerce and WPSwings Subscriptions are active; otherwise, an admin notice is shown and initialization halts.
- On activation, `DSB_DB::create_tables()` is called to create the log/key tables (after dependency check; otherwise the plugin deactivates itself).
- On uninstall, if the delete option is enabled, drops both tables and removes all plugin options.
- Constructor wires core services: database (`DSB_DB`), HTTP client (`DSB_Client`), event handler (`DSB_Events`), admin UI (`DSB_Admin`), dashboard shortcode (`DSB_Dashboard`), and dashboard AJAX controller (`DSB_Dashboard_Ajax`).
- `init()` loads translations and invokes `init()` on each service to register hooks/shortcodes.

Database layer (`includes/class-dsb-db.php`)
-------------------------------------------
Tables (created via `dbDelta`):
- `wp_davix_bridge_logs`: rolling log (max 200 rows) of events sent to Node; fields include event name, customer email, plan slug, subscription/order IDs, response action, HTTP code, error excerpt, timestamps.
- `wp_davix_bridge_keys`: mirror of key metadata per subscription (email, plan slug, status, prefix/last4, Node plan ID, last action/HTTP/error, timestamps). Plaintext keys are never stored.

Key methods:
- `log_event($data)`: sanitizes and inserts an event row; trims table to last 200 entries.
- `get_logs($limit)`: fetches recent logs.
- `get_keys($per_page, $page)`, `count_keys()`: pagination helpers for the Keys admin tab.
- `upsert_key($data)`: insert or update a key row keyed by `subscription_id`.
- `find_key($subscription_id)`: fetch a key row by subscription ID.

HTTP client and settings (`includes/class-dsb-client.php`)
---------------------------------------------------------
Persistent options:
- `dsb_settings`: Node base URL, bridge token header, logging toggle, uninstall toggle, and a flag allowing manual provisioning without order/subscription references.
- `dsb_product_plans`: mapping of WooCommerce product IDs/variations → plan slug strings.
- `dsb_plan_products`: list of product IDs selected for plan synchronization.
- `dsb_plan_sync`: last plan-sync summary metadata.

Settings helpers:
- `get_settings()`, `save_settings($data)`: sanitize inputs, persist options, optionally generate plan slugs from selected products and store `_dsb_plan_slug` post meta; also mirrors uninstall preference into `dsb_delete_on_uninstall`.
- `get_product_plans()`, `get_plan_products()`, `get_plan_sync_status()`, `masked_token()`.

Request helpers:
- `request($path, $method, $body, $query)`: builds URL from `node_base_url`, attaches `x-davix-bridge-token` header, JSON-encodes POST bodies, and records request metadata for later debugging.
- `prepare_response($response)`: standardizes response, decoded JSON, HTTP code, URL, and method for AJAX consumers.

Subscription event forwarding:
- `send_event($payload)`: POST `/internal/subscription/event` with event data; logs outcome (when logging enabled) and updates `wp_davix_bridge_keys` with status, prefix/last4, plan ID, and last action/error. Payload fields: `event`, `customer_email`, `plan_slug`, `subscription_id`, `order_id`.
- `test_connection()`: GET `/internal/subscription/debug` (used by admin “Test Connection”).

Admin/Node management endpoints:
- `fetch_keys(page, per_page, search)`: GET `/internal/admin/keys` (expects pagination JSON).
- `provision_key(payload)`: POST `/internal/admin/key/provision` with `customer_email`, `plan_slug`, optional `subscription_id`/`order_id`.
- `disable_key(payload)`: POST `/internal/admin/key/disable` with `subscription_id` and/or `customer_email`.
- `rotate_key(payload)`: POST `/internal/admin/key/rotate` with `subscription_id`/`customer_email`.
- `fetch_plans()`: GET `/internal/admin/plans`.
- `sync_plan(payload)`: POST `/internal/wp-sync/plan` to push WooCommerce product plan definitions; payload structure produced by `DSB_Admin::get_plan_payload_for_product()` (includes plan slug, name, billing period, quotas, feature flags, description, WP product ID).

Dashboard/user endpoints (frontend AJAX):
- `user_summary(identity)`: POST `/internal/user/summary` with identity (subscription/order/email) derived from the logged-in user.
- `user_usage(identity, range, opts)`: POST `/internal/user/usage` with identity + range (`hourly`, `daily`, `monthly`, `billing_period`) and `window` hint.
- `user_rotate(identity)`: POST `/internal/user/key/rotate`.
- `user_toggle(identity, enabled)`: POST `/internal/user/key/toggle` with `action` `enable|disable`.

Event handling (`includes/class-dsb-events.php`)
-----------------------------------------------
- Hooks WPSwings and WooCommerce events: renewal (`wps_sfw_after_renewal_payment`), expire scheduler, cancel, checkout processed, and order status changes.
- `build_payload(subscription_id, event, order?)` gathers customer email (from order or user meta), determines plan slug (product mapping first, then subscription meta `_dsb_plan_slug`/`wps_sfw_plan_slug`), and logs/aborts if subscription ID, plan slug, or customer email are missing.
- `handle_checkout()` builds `activated` payload (or `activated_pending_subscription_id` when subscription ID is missing) and only sends if the order contains a mapped product.
- `handle_order_status_change()` maps WooCommerce statuses to bridge events (`completed|processing|active`→`activated`; `cancelled|refunded|trash`→`cancelled`; `failed`→`payment_failed`; `expired`→`expired`). Missing subscription IDs are logged as `subscription_missing`.
- `maybe_send()` validates that the payload’s plan slug exists in the configured mapping; otherwise logs `plan_missing` and raises an admin notice. Successful payloads are sent via `DSB_Client::send_event()`.

Admin UI (`includes/class-dsb-admin.php`)
----------------------------------------
Tabs under **Davix Bridge** menu:
1) **Settings** – configure Node URL/token, logging/deletion/provisioning flags, select products to sync as plans (auto-detected subscription-like products), override plan slugs, trigger connection test, and trigger plan sync to Node. `sync_plans_to_node()` assembles payloads for selected products (or inferred subscription products) and calls `/internal/wp-sync/plan`; logs each sync as `plan_sync` events and stores summary in `dsb_plan_sync`.
2) **Plan Mapping** – bulk define product→plan slug pairs (persists to `dsb_product_plans`).
3) **Keys** – lists mirrored key metadata from `wp_davix_bridge_keys` with pagination; forms to rotate/disable keys (POST to `/internal/admin/key/rotate` or `/internal/admin/key/disable`), and a manual provisioning form (POST `/internal/admin/key/provision`). Validates presence of customer email & plan; requires subscription or order unless “allow provisioning without references” is enabled. Responses surfaced via notices.
4) **Logs** – displays last 200 log rows from `wp_davix_bridge_logs`.

Product plan limits UI:
- Adds “Davix Plan Limits” tab to WooCommerce product data. Fields saved as product meta: `_dsb_plan_slug`, `_dsb_monthly_quota_files`, `_dsb_max_files_per_request`, `_dsb_max_total_upload_mb`, `_dsb_max_dimension_px`, `_dsb_timeout_seconds`, `_dsb_allow_h2i`, `_dsb_allow_image`, `_dsb_allow_pdf`, `_dsb_allow_tools`, `_dsb_is_free`.
- Defaults generated from product slug/price or sane numeric defaults; reused when syncing plans to Node via `get_plan_payload_for_product()` which also infers `billing_period` from subscription-related meta keys.

Admin AJAX search handlers:
- `dsb_search_users`: searches users by email/login/display name; returns `{id, text, email}`.
- `dsb_search_subscriptions`: searches posts of subscription-like post types, returning ID/status/email.
- `dsb_search_orders`: queries WooCommerce orders by term or billing email; returns basic display strings.

Key list helper (`includes/class-dsb-keys-table.php`)
----------------------------------------------------
- Extends `WP_List_Table` to render subscription key metadata with action links (activate/deactivate/regenerate). Action URLs include nonces and route back to the Keys tab for processing via `DSB_Admin::handle_actions()`.

Customer dashboard shortcode & assets (`includes/class-dsb-dashboard.php`, `assets/js/dsb-dashboard.js`, `assets/css/dsb-dashboard.css`)
-----------------------------------------------------------------------------------------------------------
- Shortcode `[PIXLAB_DASHBOARD]` renders a styled dashboard surface if the user is logged in; otherwise, shows a login prompt.
- Enqueues `dsb-dashboard.css`, Chart.js (`assets/js/chart.min.js`), and `dsb-dashboard.js` when the shortcode is present. Localizes AJAX URL, nonce, default range, admin flag, UI strings, and endpoint colors.
- Frontend JS behavior:
  - Calls admin AJAX actions `dsb_dashboard_summary` and `dsb_dashboard_usage` (POST with nonce) to populate plan/key/usage info and stacked bar chart history. Displays per-endpoint call counts and billing window text.
  - Handles key copy, regeneration (`dsb_dashboard_rotate`), enable/disable toggle (`dsb_dashboard_toggle`), and range switching (`hourly`/`daily`/`monthly`/`billing_period`). Rotation opens a modal showing the plaintext key (once) and re-fetches summary/usage.
  - Provides basic toast/status feedback; logs debug data in console when `isAdmin` is true.
- CSS provides dark-themed cards, buttons, progress bar, modal, legend, and responsive grid layout.

Dashboard AJAX controller (`includes/class-dsb-dashboard-ajax.php`)
------------------------------------------------------------------
- AJAX actions (authenticated):
  - `dsb_dashboard_summary`: validates nonce and identity, posts to `/internal/user/summary`, normalizes the payload (plan name/billing period, key prefix/last4/status/created date, usage totals/percent, per-endpoint counts, billing window).
  - `dsb_dashboard_usage`: validates nonce, accepts `range` (`hourly|daily|monthly|billing_period`), derives a `window` hint (`hours:48`, `days:30`, `months:6`, `periods:2`), posts to `/internal/user/usage`, and returns labels/series suitable for Chart.js.
  - `dsb_dashboard_rotate`: rate-limits rotations per user (≥60s apart), posts to `/internal/user/key/rotate`, and returns key prefix/last4/plaintext key (if provided) for the modal.
  - `dsb_dashboard_toggle`: posts to `/internal/user/key/toggle` with `action` derived from `enabled` boolean.
- Identity derivation (`dsb_pixlab_get_identity()`): uses the logged-in user’s email and most recent WooCommerce order to infer `subscription_id` (from meta keys `wps_sfw_subscription_id`, `subscription_id`, `_subscription_id`) and `order_id` fallback. Email is always included when available.
- Error handling: uniform JSON responses with optional `debug` payload (URL/method/http/body excerpt/error) when diagnostics are enabled (admins or `DSB_DASH_DIAG`). Errors are sanitized to avoid leaking the bridge token before logging via `error_log`.

Node reference implementation (`node/internal-admin-routes.js`, `node/key-service.js`)
-------------------------------------------------------------------------------
- Demonstrates expected backend endpoints secured by the `x-davix-bridge-token` header (env vars `SUBSCRIPTION_BRIDGE_TOKEN`/`X_DAVIX_BRIDGE_TOKEN`).
- `/internal/admin/keys` (GET): paginated list of keys; accepts `page`, `per_page`, `search`; returns `{status:'ok', page, per_page, total, items}`.
- `/internal/admin/key/provision` (POST): accepts `customer_email`, `plan_slug`, optional `subscription_id`/`order_id`; provisions or activates a key and returns `{status:'ok', action, key?, key_prefix, key_last4}`.
- `/internal/admin/key/disable` (POST): disables keys by subscription ID or email; returns `{status:'ok', action:'disabled', affected}`.
- `/internal/admin/key/rotate` (POST): rotates key for subscription/email; returns `{status:'ok', action:'rotated', key?, key_prefix, key_last4}`.
- `/internal/admin/plans` (GET): returns `{status:'ok', items}` from the backend plan service.
- `/internal/wp-sync/plan` (POST): upserts a plan from WooCommerce payload; returns `{status:'ok', action, plan_slug}`.
- `key-service.js` supplies helper functions used by the routes:
  - `generateKeyParts(rawKey?)`: generates a random base64url key (or uses provided) and derives SHA-256 hash, prefix, last4.
  - `activateOrProvisionKey(service, params)`: fetches existing key by subscription or email; creates a new key (saving license_key/hash/prefix/last4/status) or repairs missing hashes; returns action (`created`, `repaired`, or `existing`) and key parts.
  - `disableCustomerKey(service, params)`: disables keys by subscription ID or email using provided service/db helpers.
  - `enhanceKeysService(service)`: adds missing helper methods to a service instance to standardize API.

Uninstall behavior (`uninstall.php`)
------------------------------------
- If option `dsb_delete_on_uninstall` is truthy, drops both plugin tables and deletes all saved options (`dsb_settings`, product/plan mappings, plan sync status). Otherwise, data is retained.

Assets and supporting docs
--------------------------
- `assets/js/dsb-admin.js`: initializes Select2/SelectWoo controls for AJAX-powered user/subscription/order pickers and plan dropdowns in admin UI.
- `assets/js/chart.min.js`: bundled Chart.js used by dashboard charts.
- `AUDIT_REPORT.md`, `DASHBOARD_AUDIT.md`, `README.md`: supplementary human-readable overviews and audits (no executable code).

Customization & extension notes
-------------------------------
- All outbound calls include the `x-davix-bridge-token` header and expect JSON bodies/responses. Adjust `DSB_Client::request()` if the Node service contract changes (timeouts, headers, auth scheme).
- Event payload contract for `/internal/subscription/event` is defined in `DSB_Events::build_payload()`; add fields here and handle them server-side as needed. Ensure `DSB_Client::send_event()` updates the mirrored key table appropriately when response schema changes.
- Plan synchronization payload structure is centralized in `DSB_Admin::get_plan_payload_for_product()`. When adding plan features, extend this method and update Node plan upsert logic accordingly.
- Dashboard AJAX normalization (`normalize_summary_payload` in `DSB_Dashboard_Ajax`) governs what the frontend expects; any backend changes to `/internal/user/summary` or `/internal/user/usage` responses should be mirrored here.
- Logging is controlled via the “Enable logging” setting; logs and mirrored keys intentionally omit plaintext keys for security. Use `DSB_DB` helpers to adjust retention or captured fields.
