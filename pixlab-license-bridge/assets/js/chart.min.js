/*! Lightweight chart helper providing a minimal Chart.js-compatible API for the DSB dashboard. */
(function (global) {
    function Chart(ctx, config) {
        this.ctx = ctx && ctx.canvas ? ctx : ctx.getContext('2d');
        this.config = config || {};
        this.data = this.config.data || {};
        this.type = this.config.type || 'line';
        this.update();
    }

    Chart.prototype.destroy = function () {
        this.ctx = null;
    };

    Chart.prototype.update = function () {
        if (!this.ctx) {
            return;
        }
        var ctx = this.ctx;
        var canvas = ctx.canvas;
        var labels = (this.data && this.data.labels) || [];
        var datasets = (this.data && this.data.datasets) || [];
        var width = canvas.width;
        var height = canvas.height;
        ctx.clearRect(0, 0, width, height);

        if (!labels.length || !datasets.length) {
            return;
        }

        var allValues = [];
        datasets.forEach(function (ds) {
            if (Array.isArray(ds.data)) {
                allValues = allValues.concat(ds.data);
            }
        });
        var max = Math.max.apply(null, allValues.concat([1]));
        var padding = 24;
        var stepX = labels.length > 1 ? (width - padding * 2) / (labels.length - 1) : width - padding * 2;
        var yScale = (height - padding * 2) / max;

        datasets.forEach(function (ds) {
            var color = ds.borderColor || ds.backgroundColor || '#0ea5e9';
            ctx.strokeStyle = color;
            ctx.fillStyle = color;
            ctx.beginPath();
            var isBar = (ds.type || Chart.defaults.type || '').toLowerCase() === 'bar' || Chart.defaults.type === 'bar' || Chart.defaults.bar;
            if (isBar || (ds.type || '').toLowerCase() === 'bar') {
                ds.data.forEach(function (value, index) {
                    var x = padding + index * stepX;
                    var y = height - padding - value * yScale;
                    var barWidth = Math.max(6, stepX * 0.6);
                    ctx.fillRect(x - barWidth / 2, y, barWidth, height - padding - y);
                });
            } else {
                ds.data.forEach(function (value, index) {
                    var x = padding + index * stepX;
                    var y = height - padding - value * yScale;
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                    ctx.moveTo(x, y);
                    ctx.arc(x, y, 2, 0, Math.PI * 2);
                });
                ctx.stroke();
            }
        });
    };

    Chart.register = function () {};
    Chart.defaults = { plugins: { legend: { display: true } } };

    global.Chart = Chart;
})(this);
